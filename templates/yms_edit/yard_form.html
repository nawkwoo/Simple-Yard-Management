<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% if view.object %}야드 수정{% else %}야드 추가{% endif %}</title>
    <!-- 구글 지도 API 스크립트 추가 -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>
</head>
<body>
    <h1>{% if view.object %}야드 수정{% else %}야드 추가{% endif %}</h1>
    <form method="post" action="">
        {% csrf_token %}
        <p>
            {{ form.division.label_tag }}<br>
            {{ form.division }}
            {% if form.division.errors %}
                <ul class="errorlist">
                    {% for error in form.division.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </p>
        <p>
            {{ form.yard_id.label_tag }}<br>
            {{ form.yard_id }}
            {% if form.yard_id.errors %}
                <ul class="errorlist">
                    {% for error in form.yard_id.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </p>
        <p>
            {{ form.address.label_tag }}<br>
            {{ form.address }}
            {% if form.address.errors %}
                <ul class="errorlist">
                    {% for error in form.address.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </p>
        <p>
            {{ form.equipment_types.label_tag }}<br>
            <ul>
                {% for choice in form.equipment_types %}
                    <li>{{ choice.tag }} {{ choice.choice_label }}</li>
                {% endfor %}
            </ul>
            {% if form.equipment_types.errors %}
                <ul class="errorlist">
                    {% for error in form.equipment_types.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </p>
        <p>
            {{ form.is_active.label_tag }}<br>
            {{ form.is_active }}
            {% if form.is_active.errors %}
                <ul class="errorlist">
                    {% for error in form.is_active.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </p>
        <!-- 숨김 필드로 위도와 경도를 추가합니다 -->
        {{ form.latitude }}
        {{ form.longitude }}
        <button type="submit">
            {% if view.object %}야드 수정{% else %}야드 생성{% endif %}
        </button>
    </form>

    <!-- 지도 영역 추가 -->
    <div id="map" style="width:100%; height:400px; margin-top:20px;"></div>

    <a href="{% url 'yms_edit:equipment-list' %}">뒤로 가기</a>

    <!-- JavaScript -->
    <script>
        function initMap() {
            // 지도 초기 설정
            var map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 37.5665, lng: 126.9780 }, // 기본 위치 (서울)
                zoom: 12
            });

            // 지오코더 객체 생성
            var geocoder = new google.maps.Geocoder();

            // 마커 객체 생성
            var marker = new google.maps.Marker({
                map: map,
                draggable: true  // 마커를 드래그 가능하도록 설정
            });

            // 주소 입력 필드 가져오기
            var addressField = document.getElementById("id_address");

            // 주소 입력 필드 변경 시 지오코딩 수행
            addressField.addEventListener("change", function() {
                var address = addressField.value;
                geocodeAddress(geocoder, map, marker, address);
            });

            // 마커 드래그 종료 시 위도 경도 업데이트
            marker.addListener('dragend', function() {
                var position = marker.getPosition();
                updateLatLngFields(position.lat(), position.lng());
            });

            // 초기 위치 설정 (수정 시)
            {% if view.object and view.object.latitude and view.object.longitude %}
                var initialPosition = { lat: {{ view.object.latitude }}, lng: {{ view.object.longitude }} };
                marker.setPosition(initialPosition);
                map.setCenter(initialPosition);
                updateLatLngFields(initialPosition.lat, initialPosition.lng);
            {% endif %}
        }

        function geocodeAddress(geocoder, map, marker, address) {
            geocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    map.setCenter(results[0].geometry.location);
                    marker.setPosition(results[0].geometry.location);
                    updateLatLngFields(results[0].geometry.location.lat(), results[0].geometry.location.lng());
                } else {
                    alert('지오코딩 실패: ' + status);
                }
            });
        }

        function updateLatLngFields(lat, lng) {
            document.getElementById("id_latitude").value = lat;
            document.getElementById("id_longitude").value = lng;
        }

        // 페이지 로드 시 지도 초기화 함수 호출
        window.onload = function() {
            initMap();
        };
    </script>
</body>
</html>
